// Generated by CoffeeScript 1.4.0
var CanvasRendererComponent, KeyboardInputComponent, Kovas, Map, Tile,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

window.requestAnimationFrame = (function() {
  return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.msRequestAnimationFrame || window.oRequestAnimationFrame || function(f) {
    return window.setTimeout(f, 1e3 / 60);
  };
})();

document.addEventListener('DOMContentLoaded', function() {
  var game;
  game = new Kovas({
    renderer: new CanvasRendererComponent(document.getElementById('kovas')),
    input: new KeyboardInputComponent
  });
  return game.run();
});

CanvasRendererComponent = (function() {

  function CanvasRendererComponent(element) {
    this.element = element;
    this.width = window.innerWidth;
    this.height = window.innerHeight;
  }

  CanvasRendererComponent.prototype.start = function() {
    this.canvas = document.createElement('canvas');
    this.canvas.width = this.width - 50;
    this.canvas.height = this.height - 50;
    this.ctx = this.canvas.getContext('2d');
    return this.element.appendChild(this.canvas);
  };

  CanvasRendererComponent.prototype.drawEmptyTile = function(x, y) {
    return true;
  };

  CanvasRendererComponent.prototype.drawWallTile = function(x, y) {
    this.ctx.save();
    this.ctx.fillStyle = '#00f';
    this.ctx.fillRect(x * 25, y * 25, 25, 25);
    return this.ctx.restore();
  };

  CanvasRendererComponent.prototype.drawFoodTile = function(x, y) {
    x = (x * 25) + 10;
    y = (y * 25) + 10;
    this.ctx.save();
    this.ctx.fillStyle = '#fff';
    this.ctx.fillRect(x, y, 5, 5);
    return this.ctx.restore();
  };

  CanvasRendererComponent.prototype.clear = function() {
    return this.ctx.clearRect(0, 0, this.width, this.height);
  };

  return CanvasRendererComponent;

})();

KeyboardInputComponent = (function() {
  var MAPPING;

  MAPPING = {
    'left': 37,
    'right': 39,
    'down': 40,
    'up': 38
  };

  function KeyboardInputComponent() {
    this.keyUp = __bind(this.keyUp, this);

    this.keyDown = __bind(this.keyDown, this);

  }

  KeyboardInputComponent.prototype.start = function() {
    this.keys = [];
    this.keysUp = [];
    this.keysDown = [];
    window.onkeydown = this.keyDown;
    return window.onkeyup = this.keyUp;
  };

  KeyboardInputComponent.prototype.isKeyDown = function(key) {
    return this.keys[MAPPING[key]];
  };

  KeyboardInputComponent.prototype.keyWentUp = function(key) {
    return this.keysUp[MAPPING[key]];
  };

  KeyboardInputComponent.prototype.keyWentDown = function(key) {
    return this.keysDown[MAPPING[key]];
  };

  KeyboardInputComponent.prototype.keyDown = function(e) {
    this.keys[e.keyCode] = true;
    this.keysDown[e.keyCode] = true;
    if (e.keyCode >= 37 && e.keyCode <= 40) {
      return false;
    }
  };

  KeyboardInputComponent.prototype.keyUp = function(e) {
    this.keys[e.keyCode] = false;
    return this.keysUp[e.keyCode] = true;
  };

  KeyboardInputComponent.prototype.update = function() {
    this.keysUp = [];
    return this.keysDown = [];
  };

  KeyboardInputComponent.prototype.moveLeft = function() {
    return this.keyWentDown('left');
  };

  KeyboardInputComponent.prototype.moveRight = function() {
    return this.keyWentDown('right');
  };

  KeyboardInputComponent.prototype.moveUp = function() {
    return this.keyWentDown('up');
  };

  KeyboardInputComponent.prototype.moveDown = function() {
    return this.keyWentDown('down');
  };

  return KeyboardInputComponent;

})();

Tile = {
  empty: 0,
  wall: 1,
  food: 2
};

Map = (function() {
  var MAPS;

  MAPS = [
    {
      data: "####################\n#....#........#....#\n#.##.#.######.#.##.#\n#.#..............#.#\n#.#.##.#.####.##.#.#\n#......#....#......#\n#.#.##.####.#.##.#.#\n#.#..#...........#.#\n#.##.#.######.#.##.#\n#....#........#....#\n####################"
    }
  ];

  function Map(levelIndex) {
    this.levelIndex = levelIndex != null ? levelIndex : 0;
    this.tiles = {};
    this.width = 0;
    this.height = 0;
    this._loadLevel(MAPS[this.levelIndex].data);
  }

  Map.prototype.tileType = function(x, y) {
    return this.tiles[y][x];
  };

  Map.prototype._loadLevel = function(data) {
    var char, index, x, y, _base, _base1, _i, _len, _ref, _results;
    x = 0;
    y = 0;
    _ref = data.split('');
    _results = [];
    for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
      char = _ref[index];
      if (char === "\n") {
        y += 1;
        _results.push(x = 0);
      } else {
        if (x > this.width) {
          this.width = x;
        }
        if (y > this.height) {
          this.height = y;
        }
        switch (char) {
          case ".":
            (_base = this.tiles)[y] || (_base[y] = {});
            this.tiles[y][x] = Tile.food;
            _results.push(x += 1);
            break;
          case "#":
            (_base1 = this.tiles)[y] || (_base1[y] = {});
            this.tiles[y][x] = Tile.wall;
            _results.push(x += 1);
            break;
          default:
            throw "Don't know what to do with " + (char.charCodeAt(0)) + " " + char + "!";
        }
      }
    }
    return _results;
  };

  return Map;

})();

Kovas = (function() {

  function Kovas(options) {
    this.options = options;
    this.update = __bind(this.update, this);

    true;
  }

  Kovas.prototype.run = function() {
    this.map = new Map();
    this.options.input.start();
    this.options.renderer.start();
    return window.requestAnimationFrame(this.update);
  };

  Kovas.prototype.update = function() {
    var x, y, _i, _j, _ref, _ref1;
    this.options.input.update();
    this.options.renderer.clear();
    for (y = _i = 0, _ref = this.map.height; 0 <= _ref ? _i <= _ref : _i >= _ref; y = 0 <= _ref ? ++_i : --_i) {
      for (x = _j = 0, _ref1 = this.map.width; 0 <= _ref1 ? _j <= _ref1 : _j >= _ref1; x = 0 <= _ref1 ? ++_j : --_j) {
        switch (this.map.tileType(x, y)) {
          case Tile.empty:
            this.options.renderer.drawEmptyTile(x, y);
            break;
          case Tile.wall:
            this.options.renderer.drawWallTile(x, y);
            break;
          case Tile.food:
            this.options.renderer.drawFoodTile(x, y);
        }
      }
    }
    return window.requestAnimationFrame(this.update);
  };

  return Kovas;

})();
